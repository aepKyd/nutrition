# Nutrition API

Это проект API для отслеживания питания, реализованный полностью на уровне базы данных PostgreSQL. 
Бизнес-логика, включая расчеты, валидацию и "API" эндпоинты (функции и представления), 
находится внутри самой БД.

## Описание проекта

Проект представляет собой "database-as-an-application", где клиенты могут взаимодействовать 
напрямую с базой данных, вызывая SQL-функции и запрашивая представления (VIEWs).

**Технологический стек:**
- PostgreSQL 16
- Docker
- pgAdmin для администрирования

## Быстрый старт

1. **Клонируйте репозиторий:**
   ```bash
   git clone <repository_url>
   cd nutrition-api
   ```

2. **Настройте переменные окружения:**
   Скопируйте `.env.example` в `.env` и при необходимости измените значения:
   ```bash
   cp .env.example .env
   ```

3. **Запустите проект:**
   ```bash
   docker-compose up -d
   ```
   Это запустит два контейнера: `nutrition-postgres` (база данных) и `nutrition-pgadmin` (веб-интерфейс для управления БД).

4. **Проверьте статус:**
   ```bash
   docker-compose ps
   ```
   Оба сервиса должны быть в статусе `running` или `healthy`.

5. **Подключение:**
   - **PostgreSQL** доступен на `localhost:5432`
   - **pgAdmin** доступен на `http://localhost:5050`
     - Логин: `admin@example.com`
     - Пароль: `admin`

## Структура БД

База данных состоит из нескольких ключевых таблиц:

- `ingredient_categories`: Категории ингредиентов.
- `ingredients`: Справочник ингредиентов и их КБЖУ на 100г.
- `recipe_categories`: Категории рецептов.
- `recipes`: Рецепты блюд.
- `recipe_ingredients`: Связующая таблица ингредиентов в рецептах.
- `cooked_dishes`: Факты приготовления блюд.
- `consumed`: Факты потребления блюд.

Подробная диаграмма и описание находятся в `docs/ER_DIAGRAM.md`.

## Примеры использования

Для взаимодействия с API вы можете использовать любой SQL-клиент, подключившись к базе данных.

**Поиск ингредиента:**
```sql
SELECT * FROM nutrition.search_ingredients('курица', 5);
```

**Получение дневной статистики:**
```sql
SELECT nutrition.get_daily_summary('2025-11-24');
```

Больше примеров запросов находится в `docs/API_QUERIES.md`.

## Тестирование

Для запуска тестов выполните скрипт:
```bash
./tests/run_tests.sh
```

## Troubleshooting

- **Ошибка `psql: command not found` при запуске тестов:**
  Убедитесь, что скрипт `tests/run_tests.sh` использует `docker exec` для выполнения `psql` внутри контейнера.

- **Ошибки `duplicate key value` при запуске `init/07_seed_data.sql`:**
  Это означает, что база данных не была очищена перед запуском. Выполните `DROP SCHEMA nutrition CASCADE;` в `psql` или перезапустите контейнеры с удалением тома: `docker-compose down -v && docker-compose up -d`.
